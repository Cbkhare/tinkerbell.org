
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>Tinkerbell, a Provisioning Engine by Packet</title>
    <meta name="generator" content="Packet Host, Inc." />
    <meta property="og:title" content="Tinkerbell" />
    <meta property="og:locale" content="en_US" />
    <meta name="description" content="Tinkerbell, a Provisioning Engine by Packet" />
    <meta property="og:description" content="Tinkerbell, a Provisioning Engine by Packet" />
    <link rel="canonical" href="https://tinkerbell.org/" />
    <meta property="og:url" content="https://tinkerbell.org/" />
    <meta property="og:site_name" content="tinkerbell.org" />
    <link rel="icon" type="image/png" sizes="128x128" href="favicon.png?v=1">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap" rel="stylesheet">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css?v=12">
  </head>
  <body>
	<div class="logo-header">
		<div class="logo-header-dots">
			<div class="logo">
          <a href="/"><img src="logo-white.png" height=54 /></a>
			</div>
			<div class="menu">
				<ul>
					<li><a href="/">Home</a></li>
					<li><a href="/setup">Setup</a></li>
				</ul>
			</div>
		</div>
	</div>

<section class="main-content setup">

    <h2 id="provisioner-worker-setup">Provisioner and Worker Setup</h2>
    <p>This demo will guide you through the process of setting up a minimal system of two machines, a provisioner and a worker, as well as run a sample workflow that will install Ubuntu 18.04 onto the worker.</p>
    <p>Below are brief descriptions of the roles each of the machines play in the system:</p>

    <h4 id="provisioner-desc">Provisioner</h4>
    <ul>
        <li>Acts as the DHCP server</li>
        <li>Keeps track of all the workflows</li>
        <li>Hosts any files necessary for the workflows to execute</li>
    </ul>

    <h4 id="worker-desc">Worker</h4>
    <ul>
        <li>Is the machine that is being acted on</li>
        <li>Asks the provisioner for available workflows </li>
        <li>Executes the ones specified for itself</li>
    </ul>
    <p>It is important to note that you can run any workflow using this setup, but the purpose of this sample is to allow you to get a sense of how things work at a basic level.</p>

    <h3 id="create-servers">I. Create the servers</h3>
    <p>Using Terraform (with the Packet provider), create two servers <code class="language-plaintext highlighter-rouge">tf-provisioner</code> and <code class="language-plaintext highlighter-rouge">tf-worker</code> attached to the same VLAN.  </p>
    <ul>
        <li>Clone the <a href="https://github.com/tinkerbell/tink"><code>tink</code></a> repository locally and switch to the <code>demo-v2</code> branch:</li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/tinkerbell/tink.git
$ cd tink
$ git checkout demo-v2
$ cd demo/terraform
</code></pre></div></div>

    <ul>
        <li>Update the <code class="language-plaintext highlighter-rouge">&lt;packet_api_token&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;project_id&gt;</code> fields in <code class="language-plaintext highlighter-rouge">input.tf</code> with your Packet API token and desired project ID</li>

        <li>You may also update the hostnames in <code class="language-plaintext highlighter-rouge">main.tf</code> if you prefer names other than <code class="language-plaintext highlighter-rouge">tf-provisioner</code> and <code class="language-plaintext highlighter-rouge">tf-worker</code></li>

        <li>Run the following commands:</li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ terraform init
$ terraform apply
</code></pre></div></div>

    <p></p>
    <p><strong>Note:</strong> As an output, it returns the IP address of the provisioner and MAC address of the worker machine.</p>

    <h3 id="manual-setup">Manual Setup</h3>
    <p>If you do not wish to use Terraform, you can provision the servers manually with the following configurations.</p>

    <h4 id="provisioner-setup">Provisioner</h4>
    <ul>
        <li>Plan: <code class="language-plaintext highlighter-rouge">c3.small.x86</code> (or any plan that supports Layer 2)</li>
        <li>OS: <code class="language-plaintext highlighter-rouge">Ubuntu 18.04 LTS</code></li>
        <li>After device is provisioned:
            <ul>
                <li>Convert network type to <code class="language-plaintext highlighter-rouge">Mixed/Hybrid</code></li>
                <li>Attach VLAN to interface <code class="language-plaintext highlighter-rouge">eth1</code> (under Layer 2)</li></ul>
        </li>
    </ul>

    <h4 id="worker-setup">Worker</h4>
    <ul>
        <li>Facility: <code class="language-plaintext highlighter-rouge">&lt;same_as_provisioner&gt;</code></li>
        <li>Plan: <code class="language-plaintext highlighter-rouge">c2.medium.x86</code></li>
        <li>OS: <code class="language-plaintext highlighter-rouge">Custom iPXE</code>
            <ul>
                <li>IPXE Script URL: <code class="language-plaintext highlighter-rouge">https://boot.netboot.xyz</code></li>
                <li>Always/Persist PXE: <code class="language-plaintext highlighter-rouge">true</code></li></ul>
        </li>
        <li>After device is provisioned:
            <ul>
                <li>Convert network type to <code class="language-plaintext highlighter-rouge">Layer 2 (individual)</code></li>
                <li>Attach VLAN to interface <code class="language-plaintext highlighter-rouge">eth0</code></li>
                <li>Same VLAN as provisioner</li></ul>
        </li>
    </ul>

    <h3 id="prep-provisioner-machine">II. Prep the provisioner machine</h3>
    <p>SSH into <code class="language-plaintext highlighter-rouge">tf-provisioner</code> for the following portion.</p>
    <p><strong>Note:</strong> From here on out, assume all code blocks are run in bash unless specified.</p>

    <h4 id="run-the-setup-script">Run the setup script</h4>
    <p>The <code class="language-plaintext highlighter-rouge">setup.sh</code> script will configure the network, download necessary files, set up the certs and registry, and bring up the stack. <br />
        The script is also separated into functions so you can rerun specific parts as needed.</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/tinkerbell/tink/master/setup.sh && chmod +x setup.sh
./setup.sh
</code></pre></div></div>

    <h3 id="action-images">III. Action Images</h3>

    <p>Push the worker image responsible for retrieving and executing the workflows for the worker to the registry.</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull quay.io/tinkerbell/tink-worker:latest
docker tag quay.io/tinkerbell/tink-worker:latest 192.168.1.1/tink-worker
docker push 192.168.1.1/tink-worker
</code></pre></div></div>

    <p>The registry must have an image for all the actions in a workflow. To push an action image:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag &lt;action-image&gt; &lt;registry-host&gt;/&lt;action-image&gt;
docker push &lt;registry-host&gt;/&lt;action-image&gt;
</code></pre></div></div>

    <p>For this demo, we are going to need an action image for displaying hello-world.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull hello-world
docker tag hello-world 192.168.1.1/hello-world
docker push 192.168.1.1/hello-world
</code></pre></div></div>

    <h3 id="workflows">IV. Workflows</h3>
    <h4 id="pushing-hardware-data">Pushing hardware data into database</h4>
    <ol>
        <li>Exec into the <code class="language-plaintext highlighter-rouge">deploy_tink-cli_1</code> container.</li>
        <li>Create a script to push hardware data into the database.</li>
        <li>Export the necessary environment variables (<code class="language-plaintext highlighter-rouge">WORKER_MAC</code> and <code class="language-plaintext highlighter-rouge">WORKER_PLAN</code>).</li>
        <li>Run the script.</li>
    </ol>
    <p><strong>Note:</strong> The worker MAC can be found in the terraform output.</p>
    <pre><code>$ docker exec -it deploy_tink-cli_1 ash
/# vi /tmp/hardware.json
{
  "id": "373324c8-7fb5-11ea-9227-0242ac120004",
  "arch": "x86_64",
  "allow_pxe": true,
  "allow_workflow": true,
  "ip_addresses": [
    {
     "address": "192.168.1.5",
     "address_family": 4,
     "enabled": true,
     "gateway": "192.168.1.1",
     "management": true,
     "netmask": "255.255.255.0",
     "public": false
    }
  ],
  "facility_code": "ewr1",
  "network_ports": [
    {
      "data": {
      "mac": "<worker_mac_addr>"
      },
      "name": "eth0",
      "type": "data"
    }
  ]
}

/# tink hardware push "`cat /tmp/hardware.json`"
/# tink hardware all
</code></pre></div></div>

    <h4 id="creating-workflow">Creating a workflow</h4>
    <ol>
        <li>Exec into the <code class="language-plaintext highlighter-rouge">deploy_tink-cli_1</code> container.</li>
        <li>Create <code class="language-plaintext highlighter-rouge">target</code>, replacing <code class="language-plaintext highlighter-rouge">&lt;worker_mac_addr&gt;</code> with the actual worker MAC address.</li>
        <li>Create <code class="language-plaintext highlighter-rouge">template</code>.</li>
        <li>Create <code class="language-plaintext highlighter-rouge">workflow</code>.</li>
    </ol>

    <pre><code>$ docker exec -it deploy_tink-cli_1 ash
/# tink target create '{"targets": {"machine1": {"mac_addr": "&lt;worker_mac_addr&gt;"}}}'
/# vi /tmp/hello.tmpl
version: '0.1'
name: hello_world
global_timeout: 6000
tasks:
- name: "hello-world"
  worker: "{{index .Targets "machine1" "mac_addr"}}"
  actions:
  - name: "hello-world"
    image: hello-world
    timeout: 90

/# tink template create -n 'hello-world' -p /tmp/hello.tmpl
/# tink workflow create -r &lt;target_id&gt; -t &lt;template_id&gt;
/# tink workflow get &lt;workflow_id&gt;
</code></pre></div></div>

    <h3 id="trigger-workflow">V. Trigger the Workflow</h3>
    <ol>
        <li>Reboot <code class="language-plaintext highlighter-rouge">tf-worker</code>.</li>
        <li>Use the Out-of-Band Console to connect with the worker machine and monitor progress.</li>
        <li>On <code class="language-plaintext highlighter-rouge">tf-provisioner</code>, you can check on the workflow state and events using:</li>
    </ol>

    <pre><code>$ docker exec -it deploy_tink-cli_1 ash
/# tink workflow state &lt;workflow-id&gt;
/# tink workflow events &lt;workflow-id&gt;
</code></pre></div></div>
    <p><strong>Note:</strong> Once the workflow succeeds, disable Always IPXE on <code class="language-plaintext highlighter-rouge">tf-worker</code> and reboot it one more time to see that it is officially running Ubuntu 18.04.</p>

    <hr />

    <h2 id="troubleshooting">Troubleshooting</h2>
    <p>The following are possible errors you might run into and their possible solutions.</p>

    <pre><code>PowerEdge R6415 - BIOS 1.8.7
A system restart is required. The system detected an exception during the UEFI
pre-boot environment.
</code></pre></div></div>
    <ul>
        <li>Set the worker to always PXE</li>
    </ul>

    <pre><code>Login did not succeed, error: Error response from daemon: Get https://192.168.1.1/v2/: x509: certificate signed by unknown authority (possibly because of "crypto/rsa: verification error" while trying to verify candidate authority certificate "Autogenerated CA")
</code></pre></div></div>
    <ul>
        <li>Rebuild the registry container (after rebuilding the certs container)</li>
    </ul>

    <pre><code>Waiting for docker to respond...
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
Error response from daemon: Get https://192.168.1.1/v2/: x509: certificate signed by unknown authority (possibly because of "crypto/rsa: verification error" while trying to verify candidate authority certificate "Autogenerated CA")
</code></pre></div></div>
    <ul>
        <li>Copy the ca.pem file over to the <code class="language-plaintext highlighter-rouge">/etc/tinkerbell/nginx/workflow</code> directory (after rebuilding the certs container)</li>
    </ul>

    <pre><code>See 'docker run --help'.
 * start-stop-daemon: failed to start `/sbin/workflow-helper'
 * Failed to start Packet Workflow
 [ !! ]
 * ERROR: workflow-helper failed to start
</code></pre></div></div>
    <ul>
        <li>Log into console with username <code class="language-plaintext highlighter-rouge">root</code> and run the following command:</li>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -it --privileged=true \
-e "DOCKER_API_VERSION=v1.35" \
-e "WORKER_ID=fde7c87c-d154-447e-9fce-7eb7bdec90c0" \
-e "DOCKER_REGISTRY=192.168.1.1" \
-e "TINKERBELL_GRPC_AUTHORITY=192.168.1.1:42113" \
-e "TINKERBELL_CERT_URL=http://192.168.1.1:42114/cert" \
-e "REGISTRY_USERNAME=admin" \
-e "REGISTRY_PASSWORD=admin123" \
-v /var/run/docker.sock:/var/run/docker.sock \
-v /worker:/worker \
-v /dev:/dev \
-v /etc/docker/cert.d/192.168.1.1:/192.168.1.1 \
192.168.1.1/tink-worker
</code></pre></div></div>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERRO[0000] Worker Finished with error rpc error: code = Unavailable desc = connection error: desc = "transport: authentication handshake failed: x509: certificate is valid for 127.0.0.1, not 192.168.1.1"
 [ ok ]
</code></pre></div></div>
    <ul>
        <li>Tear down the stack with <code class="language-plaintext highlighter-rouge">docker-compose down -v</code></li>
        <li>Rerun the setup script with just the following functions:
            <ul>
                <li><code class="language-plaintext highlighter-rouge">build_and_setup_certs</code></li>
                <li><code class="language-plaintext highlighter-rouge">build_registry_and_update_worker_image</code></li>
                <li><code class="language-plaintext highlighter-rouge">start_docker_stack</code></li>
            </ul>
        </li>
        <li>Re-push the tink-worker and action images</li>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push 192.168.1.1/tink-worker
docker push 192.168.1.1/ubuntu:base
docker push 192.168.1.1/disk-wipe:v3
docker push 192.168.1.1/disk-partition:v3
docker push 192.168.1.1/install-root-fs:v3
docker push 192.168.1.1/install-grub:v3
</code></pre></div></div>
        <li>Recreate the workflow</li>
    </ul>
</section>

  </body>
</html>

